---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getGlobalSettings, getNews } from "../../lib/microcms";
import type { News } from "../../types/microcms";

export async function getStaticPaths() {
  const news = await getNews();
  return news.map((item, i) => ({
    params: { id: item.id },
    props: {
      news: item,
      prevNews: i > 0 ? news[i - 1] : null,
      nextNews: i < news.length - 1 ? news[i + 1] : null,
    },
  }));
}

interface Props {
  news: News;
  prevNews: News | null;
  nextNews: News | null;
}

const { news, prevNews, nextNews } = Astro.props;
const settings = await getGlobalSettings();
const base = import.meta.env.BASE_URL.replace(/\/$/, "");

function formatDate(dateStr: string): string {
  const d = new Date(dateStr);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}.${m}.${day}`;
}

function formatDateJP(dateStr: string): string {
  const d = new Date(dateStr);
  return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
}
---

<BaseLayout title={news.title} settings={settings}>
  <!-- Back Button -->
  <div class="w-full px-6 md:px-20 pt-12 md:pt-20 pb-8">
    <a class="inline-flex items-center gap-2 text-xs uppercase tracking-widest text-text-muted hover:text-primary transition-colors" href={`${base}/news`}>
      <span class="material-symbols-outlined text-sm">arrow_back</span>
      Back to News
    </a>
  </div>

  <!-- Article -->
  <article class="w-full px-6 md:px-20 max-w-[1000px] mx-auto pb-24">
    <!-- Meta -->
    <div class="flex flex-col gap-6 mb-12">
      <div class="flex items-center gap-4">
        {news.category && (
          <span class="text-xs font-bold tracking-widest uppercase text-primary border border-primary/20 px-2 py-1">{news.category}</span>
        )}
        {news.published_at && (
          <time class="text-xs font-mono text-text-muted">
            {formatDate(news.published_at)}
            {news.event_date_start && news.event_date_end && (
              ` — ${formatDate(news.event_date_end).slice(5)}`
            )}
          </time>
        )}
      </div>
      <h1 class="font-serif text-3xl md:text-5xl font-medium leading-tight text-text-main dark:text-white tracking-wide">
        {news.title}
        {news.subtitle_en && (
          <span class="text-2xl md:text-3xl mt-2 block opacity-80">{news.subtitle_en}</span>
        )}
      </h1>
    </div>

    <!-- Main Image -->
    {news.main_image && (
      <div class="w-full aspect-[16/9] bg-gray-100 dark:bg-gray-800 mb-16 overflow-hidden">
        <img
          alt={news.title}
          class="w-full h-full object-cover hover:scale-105 transition-transform duration-[20s]"
          src={`${news.main_image.url}?w=1200&q=80`}
        />
      </div>
    )}

    <!-- Content + Sidebar -->
    <div class="flex flex-col md:flex-row gap-12 md:gap-24">
      <!-- Event Info Sidebar (Desktop) -->
      {(news.event_venue || news.event_date_start) && (
        <div class="hidden md:block w-1/4 shrink-0 pt-2 sticky top-24 h-fit">
          <h3 class="font-serif text-lg mb-6 border-b border-gray-200 dark:border-gray-800 pb-2">開催概要</h3>
          <dl class="flex flex-col gap-6 text-sm">
            {news.event_date_start && (
              <div>
                <dt class="text-text-muted text-xs mb-1">会期 (Date)</dt>
                <dd>
                  {formatDateJP(news.event_date_start)}
                  {news.event_date_end && ` - ${formatDateJP(news.event_date_end)}`}
                </dd>
              </div>
            )}
            {news.event_time && (
              <div>
                <dt class="text-text-muted text-xs mb-1">時間 (Time)</dt>
                <dd>{news.event_time}</dd>
              </div>
            )}
            {news.event_venue && (
              <div>
                <dt class="text-text-muted text-xs mb-1">会場 (Venue)</dt>
                <dd>{news.event_venue}</dd>
              </div>
            )}
            {news.event_closed && (
              <div>
                <dt class="text-text-muted text-xs mb-1">休廊日 (Closed)</dt>
                <dd>{news.event_closed}</dd>
              </div>
            )}
          </dl>
          {news.event_venue_url && (
            <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-800">
              <a class="inline-flex items-center gap-1 text-xs font-bold uppercase tracking-widest text-primary hover:opacity-70" href={news.event_venue_url} target="_blank" rel="noopener noreferrer">
                Google Map <span class="material-symbols-outlined text-sm">open_in_new</span>
              </a>
            </div>
          )}
        </div>
      )}

      <!-- Article Body -->
      <div class="flex-1 text-text-main dark:text-gray-200 leading-loose text-left md:text-justify font-serif rich-content">
        {news.content ? (
          <Fragment set:html={news.content} />
        ) : (
          <p class="text-text-muted">詳細は後日公開予定です。</p>
        )}

        <!-- Event Info (Mobile) -->
        {(news.event_venue || news.event_date_start) && (
          <div class="md:hidden mt-16 pt-8 border-t border-gray-200 dark:border-gray-800 font-display">
            <h3 class="font-bold mb-4">開催概要</h3>
            <dl class="flex flex-col gap-4 text-sm">
              {news.event_date_start && (
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-800 pb-2">
                  <dt class="text-text-muted">会期</dt>
                  <dd>
                    {formatDate(news.event_date_start)}
                    {news.event_date_end && ` - ${formatDate(news.event_date_end)}`}
                  </dd>
                </div>
              )}
              {news.event_time && (
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-800 pb-2">
                  <dt class="text-text-muted">時間</dt>
                  <dd>{news.event_time}</dd>
                </div>
              )}
              {news.event_venue && (
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-800 pb-2">
                  <dt class="text-text-muted">会場</dt>
                  <dd class="text-right">{news.event_venue}</dd>
                </div>
              )}
            </dl>
            {news.event_venue_url && (
              <div class="mt-6">
                <a class="flex justify-center items-center gap-2 w-full py-3 border border-text-main dark:border-white text-sm hover:bg-text-main hover:text-white dark:hover:bg-white dark:hover:text-background-dark transition-colors" href={news.event_venue_url} target="_blank" rel="noopener noreferrer">
                  Google Mapで見る
                </a>
              </div>
            )}
          </div>
        )}
      </div>
    </div>

    <!-- Prev / Next -->
    <div class="w-full h-[1px] bg-gray-200 dark:bg-gray-800 mt-12 md:mt-24 mb-12"></div>
    <div class="flex justify-between items-center text-sm font-display">
      {prevNews ? (
        <a class="group flex items-center gap-4 w-1/2 pr-4 hover:opacity-70 transition-opacity" href={`${base}/news/${prevNews.id}`}>
          <span class="material-symbols-outlined text-text-muted text-lg group-hover:-translate-x-1 transition-transform">arrow_back</span>
          <div class="flex flex-col gap-1">
            <span class="text-[10px] uppercase tracking-widest text-text-muted">Previous</span>
            <span class="line-clamp-1">{prevNews.title}</span>
          </div>
        </a>
      ) : (
        <div class="w-1/2"></div>
      )}
      <div class="w-[1px] h-12 bg-gray-200 dark:bg-gray-800 mx-4"></div>
      {nextNews ? (
        <a class="group flex items-center justify-end gap-4 w-1/2 pl-4 text-right hover:opacity-70 transition-opacity" href={`${base}/news/${nextNews.id}`}>
          <div class="flex flex-col gap-1">
            <span class="text-[10px] uppercase tracking-widest text-text-muted">Next</span>
            <span class="line-clamp-1">{nextNews.title}</span>
          </div>
          <span class="material-symbols-outlined text-text-muted text-lg group-hover:translate-x-1 transition-transform">arrow_forward</span>
        </a>
      ) : (
        <div class="w-1/2"></div>
      )}
    </div>
  </article>
</BaseLayout>
